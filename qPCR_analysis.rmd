---
title: "Waterlogging qPCR Analysis"
output: html_document
---

```{r setup, include = FALSE}

```

```{r libraries, include = FALSE}
library(data.table)
library(ggpubr)
library(kableExtra)
```

Load qPCR data from csv files exported from the qPCR machine.
Separate the qPCR data into samples, standards, and NTCs.
Remove outliers from the triplicates based on a standard deviation threshold and maximum Cq value.
Caclulate standard curves for the standards on each plate.
Calculate efficiency of each qPCR reactions.

```{r variables}

```

## Load qPCR Data

Load qPCR data from csv files exported from the qPCR machine.
Store data from each plate in a list containing data.tables for samples, standards, and NTCs.

```{r data}
# Define the columns to select from the csv file
data_columns <- c(
  "Well", "Target", "Content", "Replicate", "Sample", "Dilution",
  "Cq", "Starting Quantity (SQ)"
)

#' Load qPCR data from a csv file
#' @param file_path The path to the csv file
#' @param header_rows The number of header rows to skip
#' @param columns The columns to select
#' @return A list containing the samples, standards, and NTCs as data.tables
#'
load_qpcr_data <- function(file_path, header_rows = 0, columns = data_columns) {
	data <- fread(file_path, skip = header_rows, select = columns)
	setnames(data, "Starting Quantity (SQ)", "Concentration")
	data[, Type := fcase(
		startsWith(Content, "Unkn"), "Sample",
		startsWith(Content, "Std"), "Standard",
		startsWith(Content, "NTC"), "NTC"
	)]
  # Add leading 0 to samples for sorting
  data[Type == "Sample", Sample := sprintf("%02d", as.numeric(Sample))]
  # Calculate sample concentration
  data[Type == "Sample", Concentration := 1 / as.numeric(Dilution)]
  plate <- list(
		data 	 	  = data,
    samples   = data[Type == "Sample"],
    standards = data[Type == "Standard"],
    ntcs      = data[Type == "NTC"]
  )
  return(plate)
}

plate_1 <- load_qpcr_data("Data/2025-02-26 plate 1 roots ITS.csv", 19)
plate_2 <- load_qpcr_data("Data/2025-03-06 plate 2 roots 16S.csv", 19)

kable(head(plate_2$samples))

```

## Remove triplicate outliers

Calculate $\Delta C_q$ between each triplicate and the median and then remove outliers over a threshold.
Samples above a maximum $C_q$ value are also removed.
If only a single replicate from a triplicate remains, the sample is removed and 
the corresponding sample from the other dilution is also removed because 
efficiency cannot be calculated.

Removed outliers are listed in a dataframe.

```{r flag_outliers}

#' Flag outliers from a qPCR plate with Cq standard deviation > threshold
#' or the Cq value above a maximum value or na Cq values.
#' If only a single replicate from a triplicate remains, the sample is flagged.
#' Corresponding samples from the other dilution are also flagged.
#' @param data A data.table containing qPCR data
#' @param threshold The standard deviation threshold
#' @param max_cq The maximum Cq value to keep
#' @return The data.table with an additional column "Outlier" containing the flag
#'
flag_outliers <- function(data, threshold = 0.5, max_cq = 35) {
  outliers <- copy(data)
	
	# Group by replicate and flag outliers
	outliers[,
		Outlier := fcase(
			abs(Cq - median(Cq)) > threshold, "outlier",
			Cq > max_cq, "high Cq",
			is.na(Cq), "missing Cq",
			default = "ok"
		),
    by = .(Target, Type, Replicate)
  ]

  # Remove singletons
  outliers[,
    Outlier := ifelse(is.na(Outlier) & sum(is.na(Outlier)) == 1, "singleton", Outlier),
    by = .(Target, Type, Replicate)
  ]

  # Remove corresponding samples from other dilutions
  outliers[,
    Outlier := ifelse(
			is.na(Outlier) & sum(is.na(Outlier)) <= .N / 2,
			"insufficient data", Outlier
		),
    by = .(Target, Type, Sample)
  ]

  return(outliers)
}

plate_1$data <- flag_outliers(plate_1$data)
kable(plate_1$data[Outlier != "ok"][order(Content)], digits = 2)

plate_2$data <- flag_outliers(plate_2$data)
kable(plate_2$data[Outlier != "ok"][order(Content)], digits = 2)


# Remove outliers
plate_1$samples <- plate_1$data[Type == "Sample" & Outlier == "ok"]
plate_1$standards <- plate_1$data[Type == "Standard" & Outlier == "ok"]

plate_2$samples <- plate_2$data[Type == "Sample" & Outlier == "ok"]
plate_2$standards <- plate_2$data[Type == "Standard" & Outlier == "ok"]
```

## Summary statistics

Fit a linear model between the $C_q$ and $\log_{10}$ concentration for each sample in a qPCR plate.
Calculate PCR efficiency based on the equation 
$$E = 10^{-1/slope}$$
where $slope$ is the slope of the linear model.
Perfect efficiency is 2.

```{r summary_statistics}

#' Calculate the efficiency of a qPCR reaction based on the equation
#' \deqn{E = 10^{-1/slope}}
#' @param slope The slope between the Cq and log10 concentration
#' @return The efficiency of the qPCR reaction
#'
efficiency <- function(slope) {
  efficiency <- 10^(-1 / slope)
  return(efficiency)
}

#' Calculate summary statistics for each sample in a qPCR plate
#' @param data A data.table containing qPCR data
#' @return A data.table containing the summary statistics
#'
calculate_summary_statistics <- function(data) {
  summary_statistics <- data[,
    {
      model <- lm(Cq ~ log10(Concentration))
      intercept <- model$coefficients[1]
      slope <- model$coefficients[2]
      list(
        Target = Target[1],
        N = .N,
        Intercept = intercept,
        Slope = slope,
        R2 = summary(model)$r.squared,
        Efficiency = efficiency(slope)
      )
    },
    by = Sample
  ][order(as.numeric(Sample)]
  return(summary_statistics)
}

# Calculate summary statistics
plate_1$stats <- calculate_summary_statistics(plate_1$samples)
kable(plate_1$stats, digits = 2)
plate_2$stats <- calculate_summary_statistics(plate_2$samples)
kable(plate_2$stats, digits = 2)

# Add stats to samples
plate_1$samples <- merge(plate_1$samples, plate_1$stats, by = c("Sample", "Target"))
plate_2$samples <- merge(plate_2$samples, plate_2$stats, by = c("Sample", "Target"))
```

## Standard curve

Calculate the standard curve for each qPCR plate.
The standard curve is calculated by fitting a linear model between the $C_q$ and $\log_{10}$ concentration.

```{r standard_curve}

#' Calculate the standard curve for a qPCR plate
#' @param data A data.table containing qPCR standard curve data
#' @return A list containing the intercept, slope, R^2, and efficiency
#'
calculate_standard_curve <- function(data) {
  model <- lm(Cq ~ log10(Concentration), data)
  intercept <- model$coefficients[1]
  slope <- model$coefficients[2]
  r_squared <- summary(model)$r.squared
  efficiency <- efficiency(slope)
  return(list(intercept = intercept, slope = slope, r_squared = r_squared, efficiency = efficiency))
}

# Remove outliers from the standards
outliers <- remove_outliers(plate_1$standards)
plate_1$standards <- outliers$samples

# Calculate the standard curve
plate_1$standard_curve <- calculate_standard_curve(plate_1$standards)
plate_1$standard_curve

# Plot standard curve
plate_1$standards[, log10_concentration := log10(Concentration)]
ggscatter(
  plate_1$standards, x = "log10_concentration", y = "Cq",
  add = "reg.line", conf.int = TRUE
) +
  stat_regline_equation(
    aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~~")),
    label.x = -2, label.y = 30
  )

```
